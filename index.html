<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NIST CSF 2.0 Audit Tool Pro</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { font-family: 'Inter', sans-serif; }
        .screen { display: none; }
        .screen.active { display: block; }
        .progress-bar { transition: width 0.5s cubic-bezier(0.4, 0, 0.2, 1); width: var(--progress-width, 0%); }
        /* ƒê·ªïi m√†u ch·ªß ƒë·∫°o sang Xanh D∆∞∆°ng (Blue) ƒë·∫∑c tr∆∞ng c·ªßa NIST ƒë·ªÉ ph√¢n bi·ªát v·ªõi tool ISO (Xanh l√°) */
        #sectionList button.active { background-color: #2563eb; color: white; font-weight: 600; box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1); }
        #evidenceList::-webkit-scrollbar { width: 6px; }
        #evidenceList::-webkit-scrollbar-thumb { background-color: #bfdbfe; border-radius: 999px; }
        #evidenceList::-webkit-scrollbar-thumb:hover { background-color: #3b82f6; }
        .btn-hover-effect:hover { transform: translateY(-1px); }
        .btn-hover-effect:active { transform: translateY(0px); }
        /* Custom m√†u cho file upload NIST */
        input[type="file"]::file-selector-button { margin-right: 1rem; padding: 0.5rem 1rem; border-radius: 9999px; border: 0; font-size: 0.875rem; font-weight: 600; background-color: #eff6ff; color: #1d4ed8; cursor: pointer; transition: background-color 0.2s; }
        input[type="file"]::file-selector-button:hover { background-color: #dbeafe; }
    </style>
</head>
<body class="bg-slate-50 text-slate-800">

    <div id="screen-setup" class="screen active max-w-2xl mx-auto p-10 bg-white shadow-2xl rounded-2xl mt-20 border border-blue-100">
        <div class="text-center mb-10">
            <h1 class="text-4xl font-extrabold text-slate-800 tracking-tight">NIST CSF 2.0 <span class="text-blue-600">Master Audit</span></h1>
            <p class="text-slate-500 mt-2 text-lg">C√¥ng c·ª• ƒë√°nh gi√° An ninh m·∫°ng theo khung NIST 2.0 m·ªõi nh·∫•t.</p>
        </div>
        <div class="space-y-6">
            <div>
                <label for="clientName" class="block text-sm font-bold text-slate-700 mb-2 uppercase">T√™n Kh√°ch h√†ng / T·ªï ch·ª©c</label>
                <input type="text" id="clientName" class="block w-full p-4 border-2 border-slate-200 rounded-xl text-lg focus:border-blue-500 focus:outline-none transition-colors" placeholder="V√≠ d·ª•: Ng√¢n h√†ng ABC, Fintech XYZ...">
            </div>
            <button id="startButton" class="btn-hover-effect w-full bg-blue-600 text-white py-4 rounded-xl text-xl font-bold hover:bg-blue-700 transition shadow-lg">
                B·∫Øt ƒë·∫ßu ƒê√°nh gi√° NIST
            </button>
        </div>
    </div>

    <div id="screen-audit" class="screen max-w-[95rem] mx-auto p-6 mt-6">
        <div class="flex flex-col lg:flex-row gap-8 h-[calc(100vh-6rem)]">
            <nav class="w-full lg:w-1/4 xl:w-1/5 bg-white shadow-xl rounded-2xl overflow-hidden border border-slate-200 flex flex-col">
                <div class="p-5 bg-slate-50 border-b border-slate-200">
                    <h2 class="text-lg font-extrabold text-blue-700 uppercase">Ch·ª©c nƒÉng (Functions)</h2>
                </div>
                <div class="flex-1 overflow-y-auto p-3"><ul id="sectionList" class="space-y-1.5"></ul></div>
            </nav>

            <div class="flex-1 flex flex-col gap-6 overflow-hidden">
                <div class="bg-white p-6 shadow-md rounded-2xl border border-slate-200 flex-shrink-0">
                    <div class="flex justify-between items-center mb-6">
                        <div>
                            <div class="text-sm font-semibold text-slate-400 uppercase">ƒêang ƒë√°nh gi√°</div>
                            <h1 class="text-3xl font-bold text-slate-800 truncate" id="clientNameDisplay"></h1>
                        </div>
                         <button id="saveReportButton" class="btn-hover-effect bg-slate-800 text-white py-3 px-6 rounded-xl font-bold hover:bg-slate-900 transition shadow-md flex items-center">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 17v-2m3 2v-4m3 4v-6m2 10H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" /></svg>
                            Xu·∫•t B√°o c√°o NIST
                        </button>
                    </div>
                    <div class="bg-slate-100 p-4 rounded-xl">
                        <div class="flex justify-between text-sm font-bold text-slate-600 mb-2">
                            <span>Ti·∫øn ƒë·ªô ho√†n th√†nh</span><span id="progressText" class="text-blue-700">0/0</span>
                        </div>
                        <div class="w-full bg-slate-300 rounded-full h-4 overflow-hidden">
                            <div id="progressBar" class="progress-bar bg-gradient-to-r from-blue-600 to-blue-400 h-full rounded-full"></div>
                        </div>
                    </div>
                </div>

                <div class="flex-1 bg-white p-8 shadow-xl rounded-2xl border border-slate-200 overflow-y-auto flex flex-col">
                    <div class="flex-1">
                         <div class="mb-8">
                            <div class="flex items-center gap-3 mb-4">
                                <span class="px-4 py-1.5 bg-blue-100 text-blue-800 text-xs font-bold uppercase rounded-full" id="controlSection"></span>
                                <span class="font-mono text-sm text-slate-500 bg-slate-100 px-2 py-1 rounded-md border" id="controlId"></span>
                            </div>
                            <h2 class="text-2xl md:text-3xl font-bold text-slate-800 leading-tight" id="controlQuestion"></h2>
                             <div id="explanationArea" class="mt-5">
                                <details class="group border border-slate-200 rounded-xl overflow-hidden transition-all open:bg-blue-50/50">
                                    <summary class="flex cursor-pointer items-center justify-between p-3 bg-slate-50 hover:bg-slate-100 transition">
                                        <span class="text-sm font-semibold text-blue-700 flex items-center">
                                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
                                            H∆∞·ªõng d·∫´n & G·ª£i √Ω b·∫±ng ch·ª©ng (NIST)
                                        </span>
                                        <span class="transition group-open:rotate-180"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-blue-600" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" /></svg></span>
                                    </summary>
                                    <div id="explanationContent" class="p-5 text-sm text-slate-700 leading-relaxed border-t border-slate-200"></div>
                                </details>
                            </div>
                        </div>

                        <div class="grid grid-cols-1 xl:grid-cols-12 gap-8">
                            <div class="xl:col-span-5 space-y-8">
                                <div>
                                    <label class="block text-sm font-bold text-slate-700 mb-3 uppercase">M·ª©c ƒë·ªô ƒê√°p ·ª©ng (Tier)</label>
                                     <select id="controlStatus" class="block w-full p-3.5 border-2 border-slate-300 rounded-xl focus:border-blue-500 bg-white font-medium shadow-sm">
                                        <option value="B·ªè qua" class="text-slate-400">(Ch∆∞a ƒë√°nh gi√°)</option>
                                        <option value="ƒê√°p ·ª©ng ho√†n to√†n" class="text-blue-600 font-bold">‚úì ƒê√°p ·ª©ng ho√†n to√†n (Implemented)</option>
                                        <option value="ƒê√°p ·ª©ng m·ªôt ph·∫ßn" class="text-amber-600 font-bold">‚ö† ƒê√°p ·ª©ng m·ªôt ph·∫ßn (Partial)</option>
                                        <option value="Ch∆∞a ƒë√°p ·ª©ng" class="text-red-600 font-bold">‚úï Ch∆∞a ƒë√°p ·ª©ng (Not Implemented)</option>
                                        <option value="Kh√¥ng √°p d·ª•ng" class="text-slate-600 font-bold">‚óã Kh√¥ng √°p d·ª•ng (N/A)</option>
                                    </select>
                                </div>
                                <div>
                                     <div class="flex justify-between items-center mb-3">
                                        <label class="block text-sm font-bold text-slate-700 uppercase">B·∫±ng ch·ª©ng (Files)</label>
                                        <span class="text-xs bg-slate-100 px-2 py-1 rounded-md">ƒêa t·∫≠p tin</span>
                                    </div>
                                    <label class="flex flex-col items-center justify-center w-full h-36 border-2 border-slate-300 border-dashed rounded-xl cursor-pointer hover:bg-blue-50 hover:border-blue-400 transition relative">
                                        <div class="flex flex-col items-center justify-center pt-5 pb-6">
                                            <svg class="w-10 h-10 mb-3 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path></svg>
                                            <p class="text-sm text-slate-500 font-medium"><span class="text-blue-600 underline">Click t·∫£i l√™n</span> ho·∫∑c k√©o th·∫£ file</p>
                                            <p class="text-xs text-slate-400">(Gi·ªØ Ctrl/Shift ch·ªçn nhi·ªÅu file)</p>
                                        </div>
                                        <input id="controlEvidenceUpload" type="file" class="hidden" multiple />
                                        <div id="uploadLoading" class="absolute inset-0 bg-white/80 hidden flex flex-col items-center justify-center">
                                             <span class="text-sm font-bold text-blue-700 animate-pulse">ƒêang t·∫£i l√™n cloud...</span>
                                        </div>
                                    </label>
                                    <div id="evidenceList" class="mt-4 space-y-2 max-h-[200px] overflow-y-auto pr-1"></div>
                                </div>
                            </div>
                            <div class="xl:col-span-7">
                                <label class="block text-sm font-bold text-slate-700 mb-3 uppercase">Ghi ch√∫ / Hi·ªán tr·∫°ng th·ª±c t·∫ø</label>
                                <textarea id="controlNote" rows="12" class="block w-full p-5 border-2 border-slate-300 rounded-xl focus:border-blue-500 text-base resize-none bg-slate-50 focus:bg-white transition leading-relaxed" placeholder="M√¥ t·∫£ hi·ªán tr·∫°ng th·ª±c t·∫ø t·∫°i t·ªï ch·ª©c, c√°c l·ªó h·ªïng (Gaps) ho·∫∑c k·∫ø ho·∫°ch c·∫£i thi·ªán..."></textarea>
                            </div>
                        </div>
                    </div>
                    <div class="flex justify-between items-center pt-6 mt-8 border-t border-slate-100">
                        <button id="prevButton" class="btn-hover-effect flex items-center px-6 py-3 bg-white border-2 border-slate-200 text-slate-700 rounded-xl font-bold hover:bg-slate-50 transition disabled:opacity-50">C√¢u tr∆∞·ªõc</button>
                        <div class="text-xl font-black text-slate-300 select-none tracking-widest" id="controlCounter">1 / 100</div>
                        <button id="nextButton" class="btn-hover-effect flex items-center px-8 py-3 bg-blue-600 text-white rounded-xl font-bold hover:bg-blue-700 transition shadow-lg">Ti·∫øp theo</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="screen-done" class="screen max-w-3xl mx-auto p-12 bg-white shadow-2xl rounded-3xl mt-24 text-center border border-slate-100">
        <h1 class="text-4xl font-extrabold text-blue-700 mb-4">ƒê√°nh gi√° Ho√†n t·∫•t!</h1>
        <p class="text-slate-500 mb-10 text-xl">B√°o c√°o NIST CSF 2.0 ƒë√£ ƒë∆∞·ª£c t·∫°o th√†nh c√¥ng.</p>
        <div class="bg-slate-50 p-6 rounded-2xl mb-10 border-2 border-slate-100 inline-block mx-auto">
             <div class="flex items-center justify-center text-slate-700 font-medium">
                <span id="reportFileName" class="text-lg break-all"></span>
             </div>
        </div>
        <button id="restartButton" class="btn-hover-effect w-full md:w-2/3 mx-auto block bg-slate-800 text-white py-4 px-8 rounded-2xl text-xl font-bold hover:bg-slate-900 transition shadow-lg">B·∫Øt ƒë·∫ßu phi√™n m·ªõi</button>
    </div>

<script>
// --- DATABASE NIST CSF 2.0 (Vietnamese) ---
const CHECKLIST_DATA = [
  // === 1. GOVERN (GV - QU·∫¢N TR·ªä) ===
  {"section": "GV - QU·∫¢N TR·ªä", "id": "GV.OC-01", "question": "S·ª© m·ªánh, m·ª•c ti√™u v√† t·∫ßm nh√¨n c·ªßa t·ªï ch·ª©c c√≥ ƒë∆∞·ª£c th·∫•u hi·ªÉu v√† th√¥ng tin ƒë·∫øn c√°c b√™n li√™n quan kh√¥ng?", "explanation": "<b>√ù nghƒ©a:</b> ƒê·∫£m b·∫£o chi·∫øn l∆∞·ª£c an ninh m·∫°ng ph√π h·ª£p v·ªõi m·ª•c ti√™u kinh doanh.<br><b>B·∫±ng ch·ª©ng:</b> T√†i li·ªáu chi·∫øn l∆∞·ª£c c√¥ng ty, bi√™n b·∫£n h·ªçp BLƒê."},
  {"section": "GV - QU·∫¢N TR·ªä", "id": "GV.OC-02", "question": "C√°c b√™n li√™n quan n·ªôi b·ªô v√† b√™n ngo√†i (kh√°ch h√†ng, ƒë·ªëi t√°c, c∆° quan qu·∫£n l√Ω) c√≥ ƒë∆∞·ª£c x√°c ƒë·ªãnh r√µ r√†ng kh√¥ng?", "explanation": "<b>√ù nghƒ©a:</b> Bi·∫øt ai ·∫£nh h∆∞·ªüng ƒë·∫øn ho·∫∑c b·ªã ·∫£nh h∆∞·ªüng b·ªüi r·ªßi ro an ninh m·∫°ng.<br><b>B·∫±ng ch·ª©ng:</b> Danh s√°ch c√°c b√™n li√™n quan (Stakeholder list)."},
  {"section": "GV - QU·∫¢N TR·ªä", "id": "GV.RM-01", "question": "C√°c ∆∞u ti√™n qu·∫£n l√Ω r·ªßi ro, r√†ng bu·ªôc v√† m·ª©c ƒë·ªô ch·∫•p nh·∫≠n r·ªßi ro (Risk Appetite) c√≥ ƒë∆∞·ª£c thi·∫øt l·∫≠p v√† th√¥ng b√°o kh√¥ng?", "explanation": "<b>√ù nghƒ©a:</b> L√£nh ƒë·∫°o ch·∫•p nh·∫≠n m·∫•t bao nhi√™u ti·ªÅn/d·ªØ li·ªáu n·∫øu b·ªã hack?<br><b>B·∫±ng ch·ª©ng:</b> Tuy√™n b·ªë kh·∫©u v·ªã r·ªßi ro (Risk Appetite Statement)."},
  {"section": "GV - QU·∫¢N TR·ªä", "id": "GV.RR-01", "question": "L√£nh ƒë·∫°o t·ªï ch·ª©c c√≥ ch·ªãu tr√°ch nhi·ªám v√† cam k·∫øt v·ªÅ c√°c k·∫øt qu·∫£ chi·∫øn l∆∞·ª£c an ninh m·∫°ng kh√¥ng?", "explanation": "<b>√ù nghƒ©a:</b> 'Tone from the top'. L√£nh ƒë·∫°o ph·∫£i ch·ªãu tr√°ch nhi·ªám cu·ªëi c√πng.<br><b>B·∫±ng ch·ª©ng:</b> Quy·∫øt ƒë·ªãnh ph√¢n c√¥ng tr√°ch nhi·ªám C-level."},
  {"section": "GV - QU·∫¢N TR·ªä", "id": "GV.RR-02", "question": "Vai tr√≤, tr√°ch nhi·ªám v√† quy·ªÅn h·∫°n v·ªÅ an ninh m·∫°ng c√≥ ƒë∆∞·ª£c thi·∫øt l·∫≠p v√† th√¥ng b√°o r√µ r√†ng kh√¥ng?", "explanation": "<b>√ù nghƒ©a:</b> R√µ ng∆∞·ªùi r√µ vi·ªác (CISO l√†m g√¨, IT Admin l√†m g√¨).<br><b>B·∫±ng ch·ª©ng:</b> S∆° ƒë·ªì t·ªï ch·ª©c, M√¥ t·∫£ c√¥ng vi·ªác (JD), RACI."},
  {"section": "GV - QU·∫¢N TR·ªä", "id": "GV.PO-01", "question": "Ch√≠nh s√°ch an ninh m·∫°ng c√≥ ƒë∆∞·ª£c thi·∫øt l·∫≠p, truy·ªÅn th√¥ng v√† c·∫≠p nh·∫≠t ƒë·ªãnh k·ª≥ kh√¥ng?", "explanation": "<b>√ù nghƒ©a:</b> C√≥ 'lu·∫≠t ch∆°i' r√µ r√†ng cho to√†n t·ªï ch·ª©c.<br><b>B·∫±ng ch·ª©ng:</b> H·ªá th·ªëng ch√≠nh s√°ch ƒë√£ ban h√†nh v√† ph·ªï bi·∫øn."},
  {"section": "GV - QU·∫¢N TR·ªä", "id": "GV.SC-04", "question": "C√°c nh√† cung c·∫•p (Suppliers) c√≥ ƒë∆∞·ª£c ƒë√°nh gi√° r·ªßi ro v√† ∆∞u ti√™n qu·∫£n l√Ω kh√¥ng?", "explanation": "<b>√ù nghƒ©a:</b> Qu·∫£n l√Ω r·ªßi ro chu·ªói cung ·ª©ng (tr√°nh v·ª• vi·ªác nh∆∞ SolarWinds).<br><b>B·∫±ng ch·ª©ng:</b> Danh s√°ch nh√† cung c·∫•p quan tr·ªçng, phi·∫øu ƒë√°nh gi√° NCC."},

  // === 2. IDENTIFY (ID - NH·∫¨N DI·ªÜN) ===
  {"section": "ID - NH·∫¨N DI·ªÜN", "id": "ID.AM-01", "question": "T·ªï ch·ª©c c√≥ danh m·ª•c ki·ªÉm k√™ ƒë·∫ßy ƒë·ªß c√°c thi·∫øt b·ªã v·∫≠t l√Ω v√† h·ªá th·ªëng kh√¥ng?", "explanation": "<b>√ù nghƒ©a:</b> Kh√¥ng th·ªÉ b·∫£o v·ªá nh·ªØng g√¨ m√¨nh kh√¥ng bi·∫øt m√¨nh c√≥.<br><b>B·∫±ng ch·ª©ng:</b> File Asset Inventory (ph·∫ßn c·ª©ng)."},
  {"section": "ID - NH·∫¨N DI·ªÜN", "id": "ID.AM-02", "question": "Danh m·ª•c ph·∫ßn m·ªÅm, ·ª©ng d·ª•ng v√† c√°c n·ªÅn t·∫£ng (OS) c√≥ ƒë∆∞·ª£c ki·ªÉm k√™ v√† qu·∫£n l√Ω kh√¥ng?", "explanation": "<b>√ù nghƒ©a:</b> Qu·∫£n l√Ω license v√† c√°c ph·∫ßn m·ªÅm kh√¥ng ƒë∆∞·ª£c ph√©p (Shadow IT).<br><b>B·∫±ng ch·ª©ng:</b> Danh s√°ch ph·∫ßn m·ªÅm (Software Inventory)."},
  {"section": "ID - NH·∫¨N DI·ªÜN", "id": "ID.AM-03", "question": "C√°c lu·ªìng d·ªØ li·ªáu (data flow) v√† n∆°i l∆∞u tr·ªØ d·ªØ li·ªáu quan tr·ªçng c√≥ ƒë∆∞·ª£c x√°c ƒë·ªãnh v√† v·∫Ω s∆° ƒë·ªì kh√¥ng?", "explanation": "<b>√ù nghƒ©a:</b> Bi·∫øt d·ªØ li·ªáu nh·∫°y c·∫£m ƒëi ƒë√¢u v·ªÅ ƒë√¢u ƒë·ªÉ b·∫£o v·ªá ƒë∆∞·ªùng ƒëi ƒë√≥.<br><b>B·∫±ng ch·ª©ng:</b> S∆° ƒë·ªì lu·ªìng d·ªØ li·ªáu (DFD)."},
  {"section": "ID - NH·∫¨N DI·ªÜN", "id": "ID.RA-01", "question": "C√°c l·ªó h·ªïng b·∫£o m·∫≠t (vulnerabilities) tr√™n t√†i s·∫£n c√≥ ƒë∆∞·ª£c x√°c ƒë·ªãnh v√† l·∫≠p h·ªì s∆° kh√¥ng?", "explanation": "<b>√ù nghƒ©a:</b> Ch·ªß ƒë·ªông t√¨m l·ªói tr∆∞·ªõc khi hacker t√¨m th·∫•y.<br><b>B·∫±ng ch·ª©ng:</b> B√°o c√°o Vulnerability Scan (Nessus/Qualys)."},
  {"section": "ID - NH·∫¨N DI·ªÜN", "id": "ID.RA-02", "question": "Th√¥ng tin t√¨nh b√°o m·ªëi ƒëe d·ªça (Threat Intelligence) c√≥ ƒë∆∞·ª£c thu th·∫≠p t·ª´ c√°c ngu·ªìn b√™n ngo√†i kh√¥ng?", "explanation": "<b>√ù nghƒ©a:</b> Bi·∫øt xu h∆∞·ªõng t·∫•n c√¥ng m·ªõi ƒë·ªÉ ph√≤ng ng·ª´a.<br><b>B·∫±ng ch·ª©ng:</b> C√°c b·∫£n tin an ninh m·∫°ng, feed threat intel."},
  {"section": "ID - NH·∫¨N DI·ªÜN", "id": "ID.RA-06", "question": "ƒê√°nh gi√° r·ªßi ro c√≥ ƒë∆∞·ª£c th·ª±c hi·ªán ƒë·ªãnh k·ª≥ ho·∫∑c khi c√≥ thay ƒë·ªïi l·ªõn kh√¥ng?", "explanation": "<b>√ù nghƒ©a:</b> R·ªßi ro lu√¥n thay ƒë·ªïi, c·∫ßn ƒë√°nh gi√° l·∫°i th∆∞·ªùng xuy√™n.<br><b>B·∫±ng ch·ª©ng:</b> B√°o c√°o ƒë√°nh gi√° r·ªßi ro g·∫ßn nh·∫•t."},

  // === 3. PROTECT (PR - B·∫¢O V·ªÜ) ===
  {"section": "PR - B·∫¢O V·ªÜ", "id": "PR.AA-01", "question": "Danh t√≠nh v√† th√¥ng tin x√°c th·ª±c (user/password) c√≥ ƒë∆∞·ª£c qu·∫£n l√Ω v√† b·∫£o v·ªá kh√¥ng?", "explanation": "<b>√ù nghƒ©a:</b> ƒê·∫£m b·∫£o ƒë√∫ng ng∆∞·ªùi ƒë√∫ng quy·ªÅn. Tr√°nh l·ªô password.<br><b>B·∫±ng ch·ª©ng:</b> H·ªá th·ªëng AD/LDAP/SSO, ch√≠nh s√°ch m·∫≠t kh·∫©u."},
  {"section": "PR - B·∫¢O V·ªÜ", "id": "PR.AA-03", "question": "Quy·ªÅn truy c·∫≠p (v·∫≠t l√Ω v√† logic) c√≥ ƒë∆∞·ª£c c·∫•p theo nguy√™n t·∫Øc ƒë·∫∑c quy·ªÅn t·ªëi thi·ªÉu (least privilege) kh√¥ng?", "explanation": "<b>√ù nghƒ©a:</b> Ch·ªâ c·∫•p v·ª´a ƒë·ªß quy·ªÅn ƒë·ªÉ l√†m vi·ªác.<br><b>B·∫±ng ch·ª©ng:</b> Ma tr·∫≠n ph√¢n quy·ªÅn, bi√™n b·∫£n r√† so√°t quy·ªÅn."},
  {"section": "PR - B·∫¢O V·ªÜ", "id": "PR.AA-05", "question": "X√°c th·ª±c m·∫°nh (v√≠ d·ª•: MFA/2FA) c√≥ ƒë∆∞·ª£c √°p d·ª•ng cho c√°c truy c·∫≠p quan tr·ªçng ho·∫∑c t·ª´ xa kh√¥ng?", "explanation": "<b>√ù nghƒ©a:</b> Ch·ªëng l·∫°i vi·ªác l·ªô m·∫≠t kh·∫©u.<br><b>B·∫±ng ch·ª©ng:</b> C·∫•u h√¨nh MFA cho VPN, Email, Admin portal."},
  {"section": "PR - B·∫¢O V·ªÜ", "id": "PR.AT-01", "question": "T·∫•t c·∫£ nh√¢n vi√™n c√≥ ƒë∆∞·ª£c ƒë√†o t·∫°o nh·∫≠n th·ª©c v·ªÅ an ninh m·∫°ng ƒë·ªãnh k·ª≥ kh√¥ng?", "explanation": "<b>√ù nghƒ©a:</b> Con ng∆∞·ªùi l√† tuy·∫øn ph√≤ng th·ªß ƒë·∫ßu ti√™n.<br><b>B·∫±ng ch·ª©ng:</b> H·ªì s∆° ƒë√†o t·∫°o, k·∫øt qu·∫£ test phishing."},
  {"section": "PR - B·∫¢O V·ªÜ", "id": "PR.DS-01", "question": "D·ªØ li·ªáu nh·∫°y c·∫£m (Data-at-rest) c√≥ ƒë∆∞·ª£c b·∫£o v·ªá (v√≠ d·ª•: m√£ h√≥a) khi l∆∞u tr·ªØ kh√¥ng?", "explanation": "<b>√ù nghƒ©a:</b> M·∫•t ·ªï c·ª©ng/laptop nh∆∞ng kh√¥ng l·ªô d·ªØ li·ªáu.<br><b>B·∫±ng ch·ª©ng:</b> C·∫•u h√¨nh Bitlocker, m√£ h√≥a Database."},
  {"section": "PR - B·∫¢O V·ªÜ", "id": "PR.DS-02", "question": "D·ªØ li·ªáu ƒëang truy·ªÅn t·∫£i (Data-in-transit) c√≥ ƒë∆∞·ª£c b·∫£o v·ªá (v√≠ d·ª•: SSL/TLS, VPN) kh√¥ng?", "explanation": "<b>√ù nghƒ©a:</b> Tr√°nh nghe l√©n tr√™n ƒë∆∞·ªùng truy·ªÅn.<br><b>B·∫±ng ch·ª©ng:</b> C·∫•u h√¨nh HTTPS, VPN."},
  {"section": "PR - B·∫¢O V·ªÜ", "id": "PR.DS-11", "question": "C√°c b·∫£n sao l∆∞u (Backup) c√≥ ƒë∆∞·ª£c duy tr√¨, b·∫£o v·ªá v√† ki·ªÉm th·ª≠ ph·ª•c h·ªìi ƒë·ªãnh k·ª≥ kh√¥ng?", "explanation": "<b>√ù nghƒ©a:</b> C·ª©u c√°nh khi b·ªã Ransomware.<br><b>B·∫±ng ch·ª©ng:</b> Log backup th√†nh c√¥ng, bi√™n b·∫£n test restore."},
  {"section": "PR - B·∫¢O V·ªÜ", "id": "PR.PS-01", "question": "C·∫•u h√¨nh an to√†n (Hardening) c√≥ ƒë∆∞·ª£c thi·∫øt l·∫≠p v√† duy tr√¨ cho c√°c h·ªá th·ªëng (endpoint, server) kh√¥ng?", "explanation": "<b>√ù nghƒ©a:</b> Kh√¥ng d√πng c·∫•u h√¨nh m·∫∑c ƒë·ªãnh d·ªÖ b·ªã hack.<br><b>B·∫±ng ch·ª©ng:</b> Hardening checklist, GPO."},
  {"section": "PR - B·∫¢O V·ªÜ", "id": "PR.IR-01", "question": "M·∫°ng l∆∞·ªõi c√≥ ƒë∆∞·ª£c ph√¢n ƒëo·∫°n (Network Segmentation) ƒë·ªÉ h·∫°n ch·∫ø l√¢y lan khi b·ªã t·∫•n c√¥ng kh√¥ng?", "explanation": "<b>√ù nghƒ©a:</b> Chia ƒë·ªÉ tr·ªã. M√°y nh√¢n vi√™n nhi·ªÖm virus kh√¥ng l√¢y sang server.<br><b>B·∫±ng ch·ª©ng:</b> S∆° ƒë·ªì VLAN, c·∫•u h√¨nh Firewall zone."},

  // === 4. DETECT (DE - PH√ÅT HI·ªÜN) ===
  {"section": "DE - PH√ÅT HI·ªÜN", "id": "DE.AE-02", "question": "C√°c s·ª± ki·ªán b·∫•t th∆∞·ªùng (Anomalies) c√≥ ƒë∆∞·ª£c ph√°t hi·ªán v√† c·∫£nh b√°o k·ªãp th·ªùi kh√¥ng?", "explanation": "<b>√ù nghƒ©a:</b> Bi·∫øt ngay khi c√≥ g√¨ ƒë√≥ 'l·∫°' ƒëang x·∫£y ra.<br><b>B·∫±ng ch·ª©ng:</b> H·ªá th·ªëng c·∫£nh b√°o t·ª´ SIEM/IDS/Anti-malware."},
  {"section": "DE - PH√ÅT HI·ªÜN", "id": "DE.CM-01", "question": "H·ªá th·ªëng v√† m·∫°ng l∆∞·ªõi c√≥ ƒë∆∞·ª£c gi√°m s√°t li√™n t·ª•c ƒë·ªÉ ph√°t hi·ªán c√°c s·ª± ki·ªán an ninh ti·ªÅm ·∫©n kh√¥ng?", "explanation": "<b>√ù nghƒ©a:</b> Gi√°m s√°t 24/7 ƒë·ªÉ kh√¥ng b·ªè l·ªçt cu·ªôc t·∫•n c√¥ng.<br><b>B·∫±ng ch·ª©ng:</b> Dashboard gi√°m s√°t (SOC/NOC)."},
  {"section": "DE - PH√ÅT HI·ªÜN", "id": "DE.CM-03", "question": "Ho·∫°t ƒë·ªông c·ªßa nh√¢n s·ª± v√† c√°c k·∫øt n·ªëi t·ª´ b√™n ngo√†i c√≥ ƒë∆∞·ª£c gi√°m s√°t kh√¥ng?", "explanation": "<b>√ù nghƒ©a:</b> Ph√°t hi·ªán n·ªôi gi√°n ho·∫∑c hacker d√πng t√†i kho·∫£n h·ª£p l·ªá.<br><b>B·∫±ng ch·ª©ng:</b> Log truy c·∫≠p VPN, log h√†nh vi ng∆∞·ªùi d√πng (UEBA)."},
  {"section": "DE - PH√ÅT HI·ªÜN", "id": "DE.CM-06", "question": "Ho·∫°t ƒë·ªông gi√°m s√°t c√≥ bao g·ªìm vi·ªác ki·ªÉm tra s·ª± hi·ªán di·ªán c·ªßa m√£ ƒë·ªôc (Malware) kh√¥ng?", "explanation": "<b>√ù nghƒ©a:</b> C∆° b·∫£n nh·∫•t c·ªßa ph√°t hi·ªán.<br><b>B·∫±ng ch·ª©ng:</b> Ph·∫ßn m·ªÅm Antivirus/EDR ƒëang ho·∫°t ƒë·ªông."},
  {"section": "DE - PH√ÅT HI·ªÜN", "id": "DE.CM-09", "question": "C√°c c·∫£nh b√°o an ninh (Security Alerts) c√≥ ƒë∆∞·ª£c ph√¢n lo·∫°i v√† ∆∞u ti√™n x·ª≠ l√Ω kh√¥ng?", "explanation": "<b>√ù nghƒ©a:</b> Tr√°nh b·ªã 'ng·∫≠p' trong c·∫£nh b√°o gi·∫£.<br><b>B·∫±ng ch·ª©ng:</b> Quy tr√¨nh Triage (ph√¢n lo·∫°i) c·∫£nh b√°o."},

  // === 5. RESPOND (RS - ·ª®NG PH√ì) ===
  {"section": "RS - ·ª®NG PH√ì", "id": "RS.MA-01", "question": "K·∫ø ho·∫°ch ·ª©ng ph√≥ s·ª± c·ªë (Incident Response Plan) c√≥ ƒë∆∞·ª£c thi·∫øt l·∫≠p v√† duy tr√¨ kh√¥ng?", "explanation": "<b>√ù nghƒ©a:</b> K·ªãch b·∫£n s·∫µn s√†ng khi c√≥ 'bi·∫øn'.<br><b>B·∫±ng ch·ª©ng:</b> T√†i li·ªáu K·∫ø ho·∫°ch ·ª©ng ph√≥ s·ª± c·ªë (IRP)."},
  {"section": "RS - ·ª®NG PH√ì", "id": "RS.MA-02", "question": "C√°c s·ª± c·ªë c√≥ ƒë∆∞·ª£c b√°o c√°o k·ªãp th·ªùi theo c√°c ti√™u ch√≠ ƒë√£ quy ƒë·ªãnh kh√¥ng?", "explanation": "<b>√ù nghƒ©a:</b> Bi·∫øt s·ªõm x·ª≠ l√Ω s·ªõm.<br><b>B·∫±ng ch·ª©ng:</b> Quy tr√¨nh b√°o c√°o, c√°c ticket s·ª± c·ªë."},
  {"section": "RS - ·ª®NG PH√ì", "id": "RS.AN-03", "question": "C√°c s·ª± c·ªë c√≥ ƒë∆∞·ª£c ph√¢n t√≠ch ƒë·ªÉ hi·ªÉu r√µ nguy√™n nh√¢n g·ªëc r·ªÖ, ph·∫°m vi v√† t√°c ƒë·ªông kh√¥ng?", "explanation": "<b>√ù nghƒ©a:</b> Hi·ªÉu r√µ k·∫ª ƒë·ªãch ƒë√£ l√†m g√¨, v√†o s√¢u ƒë·∫øn ƒë√¢u.<br><b>B·∫±ng ch·ª©ng:</b> B√°o c√°o ƒëi·ªÅu tra s·ª± c·ªë (Forensics report)."},
  {"section": "RS - ·ª®NG PH√ì", "id": "RS.MI-01", "question": "C√°c h√†nh ƒë·ªông ngƒÉn ch·∫∑n (Containment) v√† di·ªát tr·ª´ (Eradication) c√≥ ƒë∆∞·ª£c th·ª±c hi·ªán ƒë·ªÉ gi·∫£m thi·ªÉu thi·ªát h·∫°i kh√¥ng?", "explanation": "<b>√ù nghƒ©a:</b> C√¥ l·∫≠p m√°y nhi·ªÖm virus ngay l·∫≠p t·ª©c.<br><b>B·∫±ng ch·ª©ng:</b> Nh·∫≠t k√Ω x·ª≠ l√Ω s·ª± c·ªë (ghi l·∫°i c√°c b∆∞·ªõc ƒë√£ l√†m)."},
  {"section": "RS - ·ª®NG PH√ì", "id": "RS.CO-02", "question": "Vi·ªác th√¥ng b√°o s·ª± c·ªë cho c√°c b√™n li√™n quan (n·ªôi b·ªô, kh√°ch h√†ng, c∆° quan ch·ª©c nƒÉng) c√≥ ƒë∆∞·ª£c th·ª±c hi·ªán khi c·∫ßn thi·∫øt kh√¥ng?", "explanation": "<b>√ù nghƒ©a:</b> Tu√¢n th·ªß lu·∫≠t v√† gi·ªØ uy t√≠n.<br><b>B·∫±ng ch·ª©ng:</b> K·ªãch b·∫£n truy·ªÅn th√¥ng khi kh·ªßng ho·∫£ng."},

  // === 6. RECOVER (RC - PH·ª§C H·ªíI) ===
  {"section": "RC - PH·ª§C H·ªíI", "id": "RC.RP-01", "question": "K·∫ø ho·∫°ch ph·ª•c h·ªìi (Recovery Plan) c√≥ ƒë∆∞·ª£c th·ª±c hi·ªán ngay sau s·ª± c·ªë kh√¥ng?", "explanation": "<b>√ù nghƒ©a:</b> ƒê∆∞a h·ªá th·ªëng ho·∫°t ƒë·ªông tr·ªü l·∫°i nhanh nh·∫•t c√≥ th·ªÉ.<br><b>B·∫±ng ch·ª©ng:</b> Quy tr√¨nh k√≠ch ho·∫°t DRP/BCP."},
  {"section": "RC - PH·ª§C H·ªíI", "id": "RC.RP-03", "question": "C√°c b·∫£n sao l∆∞u (Backup) c√≥ ƒë∆∞·ª£c s·ª≠ d·ª•ng hi·ªáu qu·∫£ ƒë·ªÉ kh√¥i ph·ª•c h·ªá th·ªëng kh√¥ng?", "explanation": "<b>√ù nghƒ©a:</b> Backup ph·∫£i d√πng ƒë∆∞·ª£c khi c·∫ßn.<br><b>B·∫±ng ch·ª©ng:</b> Bi√™n b·∫£n kh√¥i ph·ª•c d·ªØ li·ªáu th·ª±c t·∫ø."},
  {"section": "RC - PH·ª§C H·ªíI", "id": "RC.RP-06", "question": "T√≠nh to√†n v·∫πn c·ªßa c√°c b·∫£n sao l∆∞u c√≥ ƒë∆∞·ª£c ki·ªÉm tra tr∆∞·ªõc khi ph·ª•c h·ªìi kh√¥ng?", "explanation": "<b>√ù nghƒ©a:</b> Tr√°nh kh√¥i ph·ª•c l·∫°i ch√≠nh con virus ƒë√£ ƒë∆∞·ª£c backup.<br><b>B·∫±ng ch·ª©ng:</b> Quy tr√¨nh ki·ªÉm tra malware cho b·∫£n backup."},
  {"section": "RC - PH·ª§C H·ªíI", "id": "RC.CO-03", "question": "C√°c ho·∫°t ƒë·ªông ph·ª•c h·ªìi c√≥ ƒë∆∞·ª£c truy·ªÅn th√¥ng r√µ r√†ng ƒë·∫øn c√°c b√™n li√™n quan kh√¥ng?", "explanation": "<b>√ù nghƒ©a:</b> ƒê·ªÉ m·ªçi ng∆∞·ªùi bi·∫øt khi n√†o h·ªá th·ªëng ch·∫°y l·∫°i b√¨nh th∆∞·ªùng.<br><b>B·∫±ng ch·ª©ng:</b> Email/Th√¥ng b√°o tr·∫°ng th√°i h·ªá th·ªëng."},
  {"section": "RC - PH·ª§C H·ªíI", "id": "RC.CO-04", "question": "B√†i h·ªçc kinh nghi·ªám (Lessons Learned) c√≥ ƒë∆∞·ª£c r√∫t ra sau s·ª± c·ªë ƒë·ªÉ c·∫£i thi·ªán chi·∫øn l∆∞·ª£c t∆∞∆°ng lai kh√¥ng?", "explanation": "<b>√ù nghƒ©a:</b> Kh√¥ng ƒë·ªÉ v·∫•p ng√£ 2 l·∫ßn v√¨ c√πng 1 l·ªói.<br><b>B·∫±ng ch·ª©ng:</b> B√°o c√°o Post-Incident Review."}
];

let currentQuestionIndex = 0, clientName = "", auditResults = [], isDirty = false, sections = [];
const els = {
    clientNameInput: document.getElementById('clientName'), startButton: document.getElementById('startButton'),
    clientNameDisplay: document.getElementById('clientNameDisplay'), saveReportButton: document.getElementById('saveReportButton'),
    sectionList: document.getElementById('sectionList'), progressText: document.getElementById('progressText'),
    progressBar: document.getElementById('progressBar'), controlSection: document.getElementById('controlSection'),
    controlId: document.getElementById('controlId'), controlQuestion: document.getElementById('controlQuestion'),
    controlStatus: document.getElementById('controlStatus'), controlEvidenceUpload: document.getElementById('controlEvidenceUpload'),
    evidenceList: document.getElementById('evidenceList'), uploadLoading: document.getElementById('uploadLoading'),
    controlNote: document.getElementById('controlNote'), prevButton: document.getElementById('prevButton'),
    nextButton: document.getElementById('nextButton'), controlCounter: document.getElementById('controlCounter'), reportFileName: document.getElementById('reportFileName')
};
const screens = { setup: document.getElementById('screen-setup'), audit: document.getElementById('screen-audit'), done: document.getElementById('screen-done') };

window.addEventListener('beforeunload', (e) => { if (isDirty) { e.preventDefault(); e.returnValue = ''; } });
function showScreen(sid) { Object.values(screens).forEach(s => s.classList.remove('active')); screens[sid].classList.add('active'); }
function populateSidebar() {
    sections = [...new Set(CHECKLIST_DATA.map(item => item.section))]; els.sectionList.innerHTML = '';
    sections.forEach(sec => {
        const li = document.createElement('li'), btn = document.createElement('button');
        btn.className = "w-full text-left p-3 rounded-lg font-medium text-slate-600 hover:bg-blue-50 hover:text-blue-700 transition duration-150";
        btn.textContent = sec; btn.onclick = () => jumpToSection(sec); li.appendChild(btn); els.sectionList.appendChild(li);
    });
}
function updateSidebarHighlight(curr) { els.sectionList.querySelectorAll('button').forEach(b => b.classList.toggle('active', b.textContent === curr)); }
function jumpToSection(name) { saveCurrentAnswer(); currentQuestionIndex = CHECKLIST_DATA.findIndex(i => i.section === name); loadQuestion(currentQuestionIndex); updateProgress(); }
function startAudit() {
    clientName = els.clientNameInput.value.trim(); if (clientName === "") return alert("Vui l√≤ng nh·∫≠p t√™n kh√°ch h√†ng.");
    els.clientNameDisplay.textContent = clientName;
    auditResults = CHECKLIST_DATA.map(item => ({ ...item, status: "B·ªè qua", note: "", evidence_files: [] }));
    populateSidebar(); currentQuestionIndex = 0; loadQuestion(0); updateProgress(); showScreen('audit'); isDirty = true;
}
function renderEvidenceList() {
    const files = auditResults[currentQuestionIndex].evidence_files || []; els.evidenceList.innerHTML = '';
    if (files.length === 0) { els.evidenceList.innerHTML = '<div class="text-sm text-slate-400 italic pl-2">Ch∆∞a c√≥ file b·∫±ng ch·ª©ng.</div>'; return; }
    files.forEach((url, index) => {
        const div = document.createElement('div'); div.className = 'flex items-center justify-between p-2.5 bg-blue-50 rounded-lg border border-blue-100 group hover:border-blue-300 transition';
        div.innerHTML = `<a href="${url}" target="_blank" class="text-sm text-blue-700 hover:underline truncate flex-1 mr-3 font-medium" title="${url.split('/').pop()}">üìÑ ${url.split('/').pop()}</a><button type="button" class="text-slate-400 hover:text-red-500 focus:outline-none p-1.5 rounded-full hover:bg-red-50 transition" title="X√≥a file n√†y" onclick="removeEvidenceFile(${index})"><svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd" /></svg></button>`;
        els.evidenceList.appendChild(div);
    });
}
window.removeEvidenceFile = function(fileIndex) { if (confirm('B·∫°n ch·∫Øc ch·∫Øn mu·ªën x√≥a file n√†y?')) { auditResults[currentQuestionIndex].evidence_files.splice(fileIndex, 1); renderEvidenceList(); }};
function loadQuestion(idx) {
    const item = CHECKLIST_DATA[idx], res = auditResults[idx];
    els.controlSection.textContent = item.section; els.controlId.textContent = item.id; els.controlQuestion.textContent = item.question; els.controlStatus.value = res.status;
    renderEvidenceList(); els.controlEvidenceUpload.value = null; els.controlNote.value = res.note; els.controlCounter.textContent = `${idx + 1} / ${CHECKLIST_DATA.length}`;
    updateSidebarHighlight(item.section);
    els.prevButton.disabled = (idx === 0); els.prevButton.classList.toggle('opacity-50', idx === 0); els.prevButton.classList.toggle('cursor-not-allowed', idx === 0);
    const isLast = idx === CHECKLIST_DATA.length - 1;
    els.nextButton.innerHTML = isLast ? `Ho√†n th√†nh <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 ml-2" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd" /></svg>` : `Ti·∫øp theo <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 ml-2" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd" /></svg>`;
    els.nextButton.classList.toggle('bg-blue-800', isLast); els.nextButton.classList.toggle('hover:bg-blue-900', isLast);
    els.nextButton.classList.toggle('bg-blue-600', !isLast); els.nextButton.classList.toggle('hover:bg-blue-700', !isLast);
    const expArea = document.getElementById('explanationArea'), expContent = document.getElementById('explanationContent');
    if (expArea.querySelector('details')) expArea.querySelector('details').removeAttribute('open');
    if (item.explanation) { expArea.classList.remove('hidden'); expContent.innerHTML = item.explanation; } else { expArea.classList.add('hidden'); }
}
async function handleFileUpload(e) {
    const files = e.target.files; if (!files || files.length === 0) return;
    els.uploadLoading.classList.remove('hidden');
    const safeName = clientName ? clientName.trim().replace(/[^a-z0-9]/gi, '-').toLowerCase() : 'unknown';
    for (let i = 0; i < files.length; i++) {
        const formData = new FormData(); formData.append('file', files[i]);
        try {
            const res = await fetch('/api/upload', { method: 'POST', headers: { 'x-client-name': safeName }, body: formData });
            if (!res.ok) throw new Error((await res.json()).error || 'Upload th·∫•t b·∫°i.');
            const data = await res.json(); auditResults[currentQuestionIndex].evidence_files.push(data.url);
        } catch (err) { console.error(err); alert(`L·ªói khi t·∫£i file ${files[i].name}: ${err.message}`); }
    }
    els.uploadLoading.classList.add('hidden'); renderEvidenceList(); e.target.value = null;
}
function saveCurrentAnswer() { if(auditResults[currentQuestionIndex]) { auditResults[currentQuestionIndex].status = els.controlStatus.value; auditResults[currentQuestionIndex].note = els.controlNote.value.trim(); } }
function nextQuestion() { saveCurrentAnswer(); if (currentQuestionIndex < CHECKLIST_DATA.length - 1) { currentQuestionIndex++; loadQuestion(currentQuestionIndex); } else { generateReport(); } updateProgress(); }
function prevQuestion() { saveCurrentAnswer(); if (currentQuestionIndex > 0) { currentQuestionIndex--; loadQuestion(currentQuestionIndex); } updateProgress(); }
function updateProgress() { const answered = auditResults.filter(r => r.status !== "B·ªè qua").length; els.progressText.textContent = `${answered}/${CHECKLIST_DATA.length}`; els.progressBar.style.setProperty('--progress-width', `${(answered / CHECKLIST_DATA.length) * 100}%`); }

function generateReport() {
    try {
        if (!confirm("B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën ho√†n th√†nh v√† xu·∫•t b√°o c√°o NIST CSF kh√¥ng?")) return;
        saveCurrentAnswer(); updateProgress();
        const total = CHECKLIST_DATA.length, audited = auditResults.filter(r => r.status !== "B·ªè qua").length, compliant = auditResults.filter(r => r.status === "ƒê√°p ·ª©ng ho√†n to√†n").length, partial = auditResults.filter(r => r.status === "ƒê√°p ·ª©ng m·ªôt ph·∫ßn").length, notimpl = auditResults.filter(r => r.status === "Ch∆∞a ƒë√°p ·ª©ng").length, na = auditResults.filter(r => r.status === "Kh√¥ng √°p d·ª•ng").length, denom = audited - na;
        // T√≠nh ƒëi·ªÉm NIST: (ƒê√°p ·ª©ng ho√†n to√†n * 1 + ƒê√°p ·ª©ng m·ªôt ph·∫ßn * 0.5) / T·ªïng s·ªë √°p d·ª•ng
        const score = denom > 0 ? Math.round(((compliant * 1 + partial * 0.5) / denom) * 100) : 0;
        let evalText = "", evalColor = ""; if (score >= 90) { evalText = "H·ªá th·ªëng ƒëang ·ªü Tier 4 (Adaptive) - R·∫•t t·ªët."; evalColor = "text-blue-600"; } else if (score >= 70) { evalText = "H·ªá th·ªëng ƒëang ·ªü Tier 3 (Repeatable) - Kh√°."; evalColor = "text-emerald-600"; } else if (score >= 40) { evalText = "H·ªá th·ªëng ƒëang ·ªü Tier 2 (Risk Informed) - Trung b√¨nh."; evalColor = "text-amber-600"; } else { evalText = "H·ªá th·ªëng ƒëang ·ªü Tier 1 (Partial) - C·∫ßn c·∫£i thi·ªán g·∫•p."; evalColor = "text-red-600"; }
        const sectionStats = {}; auditResults.forEach(r => { if (!sectionStats[r.section]) sectionStats[r.section] = { score: 0, count: 0 }; if (r.status !== "B·ªè qua" && r.status !== "Kh√¥ng √°p d·ª•ng") { sectionStats[r.section].count++; if (r.status === "ƒê√°p ·ª©ng ho√†n to√†n") sectionStats[r.section].score += 1; if (r.status === "ƒê√°p ·ª©ng m·ªôt ph·∫ßn") sectionStats[r.section].score += 0.5; } });
        const chartLabels = Object.keys(sectionStats), chartData = chartLabels.map(s => sectionStats[s].count > 0 ? Math.round((sectionStats[s].score / sectionStats[s].count) * 100) : 0);
        const now = new Date(), reportDate = `${now.getDate()}/${now.getMonth()+1}/${now.getFullYear()}`, safeName = clientName.replace(/[^a-z0-9]/gi, '_').toLowerCase();
        
        const reportHTML = `<!DOCTYPE html><html lang="vi"><head><meta charset="UTF-8"><title>B√°o c√°o NIST CSF 2.0 - ${clientName}</title><script src="https://cdn.tailwindcss.com"><\/script><script src="https://cdn.jsdelivr.net/npm/chart.js"><\/script><style>@media print{@page{size:A4 landscape;margin:10mm}body{margin:0;padding:0;background:white}.container{width:100%!important;max-width:none!important;box-shadow:none!important;margin:0!important;padding:0!important}.no-print{display:none!important}.page-break{page-break-before:always}h2,h3,.bg-slate-50,tr{break-inside:avoid}canvas{max-width:100%!important;max-height:100%!important}}body{font-family:'Inter',sans-serif;background:#f8fafc}.container{max-width:1000px;margin:0 auto;background:white;padding:40px;box-shadow:0 10px 30px -10px rgba(0,0,0,.1)}</style></head><body class="p-0 md:p-10"><div class="container mx-auto my-10 rounded-xl" id="report-container"><div class="flex justify-between items-center border-b-2 border-slate-800 pb-6 mb-8"><div><h1 class="text-4xl font-extrabold text-slate-800 uppercase">B√°o c√°o ƒê√°nh gi√°</h1><div class="text-xl font-semibold text-blue-600 mt-1">NIST CSF 2.0</div></div><div class="text-right"><div class="text-slate-500 font-medium">T·ªï ch·ª©c ƒë∆∞·ª£c ƒë√°nh gi√°</div><div class="text-2xl font-bold text-slate-800">${clientName}</div><div class="text-slate-400 text-sm mt-1">Ng√†y: ${reportDate}</div></div></div><div class="bg-slate-50 rounded-2xl p-8 mb-10 border border-slate-200"><h2 class="text-2xl font-bold text-slate-800 mb-6 flex items-center"><span class="bg-blue-600 w-2 h-8 mr-3 rounded-full"></span>1. T√≥m t·∫Øt T·ªïng quan (Executive Summary)</h2><div class="grid grid-cols-1 md:grid-cols-3 gap-8"><div class="flex flex-col items-center justify-center p-6 bg-white rounded-xl shadow-sm border border-slate-100"><div class="relative w-40 h-40"><svg class="w-full h-full" viewBox="0 0 36 36"><path d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831" fill="none" stroke="#e2e8f0" stroke-width="3"/><path d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831" fill="none" stroke="${score >= 70 ? '#2563eb' : (score >= 40 ? '#d97706' : '#dc2626')}" stroke-width="3" stroke-dasharray="${score}, 100"/><text x="18" y="20.5" font-size="8" font-weight="bold" text-anchor="middle" dominant-baseline="central" fill="${score >= 70 ? '#2563eb' : (score >= 40 ? '#d97706' : '#dc2626')}">${score}%</text></svg></div><div class="mt-4 text-lg font-bold text-slate-700">ƒêi·ªÉm Maturity</div></div><div class="md:col-span-2 flex flex-col justify-center space-y-6"><div class="grid grid-cols-4 gap-2 text-center text-xs md:text-sm"><div class="p-3 bg-blue-50 rounded-lg border border-blue-100"><div class="text-2xl font-extrabold text-blue-600">${compliant}</div><div class="font-semibold text-blue-800">ƒê√°p ·ª©ng ƒë·ªß</div></div><div class="p-3 bg-amber-50 rounded-lg border border-amber-100"><div class="text-2xl font-extrabold text-amber-600">${partial}</div><div class="font-semibold text-amber-800">M·ªôt ph·∫ßn</div></div><div class="p-3 bg-red-50 rounded-lg border border-red-100"><div class="text-2xl font-extrabold text-red-600">${notimpl}</div><div class="font-semibold text-red-800">Ch∆∞a ƒë√°p ·ª©ng</div></div><div class="p-3 bg-slate-100 rounded-lg border border-slate-200"><div class="text-2xl font-extrabold text-slate-600">${na}</div><div class="font-semibold text-slate-700">N/A</div></div></div><div class="p-5 bg-white rounded-xl border-l-4 ${score >= 70 ? 'border-blue-500' : (score >= 40 ? 'border-amber-500' : 'border-red-500')} shadow-sm"><div class="text-sm font-bold text-slate-400 uppercase mb-1">Nh·∫≠n ƒë·ªãnh s∆° b·ªô</div><div class="text-lg font-bold ${evalColor}">${evalText}</div></div></div></div></div><div class="mb-12"><h2 class="text-2xl font-bold text-slate-800 mb-6 flex items-center"><span class="bg-blue-600 w-2 h-8 mr-3 rounded-full"></span>2. Bi·ªÉu ƒë·ªì Tr∆∞·ªüng th√†nh theo Ch·ª©c nƒÉng (NIST Functions)</h2><div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-200" style="height:400px"><canvas id="domainChart"></canvas></div></div><div class="page-break"></div><div class="mb-12 mt-10"><h2 class="text-2xl font-bold text-slate-800 mb-6 flex items-center text-red-700"><span class="bg-red-600 w-2 h-8 mr-3 rounded-full"></span>3. C√°c ƒêi·ªÉm y·∫øu C·∫ßn kh·∫Øc ph·ª•c ngay (Gaps)</h2>${notimpl===0?'<div class="p-5 bg-blue-50 text-blue-700 rounded-xl font-medium border border-blue-200">Tuy·ªát v·ªùi! Kh√¥ng c√≥ h·∫°ng m·ª•c n√†o "Ch∆∞a ƒë√°p ·ª©ng".</div>':`<table class="w-full text-sm text-left text-slate-700 border-collapse"><thead class="text-xs text-white uppercase bg-red-700"><tr><th class="px-4 py-3 rounded-tl-lg">ID</th><th class="px-4 py-3">Ki·ªÉm so√°t (Subcategory)</th><th class="px-4 py-3 rounded-tr-lg">Hi·ªán tr·∫°ng & Ghi ch√∫</th></tr></thead><tbody>${auditResults.filter(r=>r.status==="Ch∆∞a ƒë√°p ·ª©ng").map(r=>`<tr class="border-b border-slate-200 bg-red-50/30"><td class="px-4 py-4 font-bold text-red-700 align-top">${r.id}</td><td class="px-4 py-4 font-medium align-top">${r.question}</td><td class="px-4 py-4 text-slate-600 align-top">${r.note||'Ch∆∞a c√≥ ghi ch√∫.'}</td></tr>`).join('')}</tbody></table>`}</div><div><h2 class="text-2xl font-bold text-slate-800 mb-6 flex items-center"><span class="bg-blue-600 w-2 h-8 mr-3 rounded-full"></span>4. Chi ti·∫øt K·∫øt qu·∫£ ƒê√°nh gi√°</h2><div class="overflow-x-auto rounded-xl border border-slate-200"><table class="w-full text-sm text-left text-slate-700"><thead class="text-xs text-slate-700 uppercase bg-slate-100"><tr><th class="px-4 py-3">ID</th><th class="px-4 py-3">Tr·∫°ng th√°i</th><th class="px-4 py-3 w-1/3">Ghi ch√∫</th><th class="px-4 py-3">B·∫±ng ch·ª©ng</th></tr></thead><tbody class="divide-y divide-slate-200">${auditResults.filter(r=>r.status!=="B·ªè qua").map(r=>`<tr class="bg-white hover:bg-slate-50"><td class="px-4 py-4 font-medium align-top">${r.id}</td><td class="px-4 py-4 align-top"><span class="px-3 py-1 rounded-full text-xs font-bold ${r.status==='ƒê√°p ·ª©ng ho√†n to√†n'?'bg-blue-100 text-blue-800':r.status==='Ch∆∞a ƒë√°p ·ª©ng'?'bg-red-100 text-red-800':r.status==='ƒê√°p ·ª©ng m·ªôt ph·∫ßn'?'bg-amber-100 text-amber-800':'bg-slate-100 text-slate-800'}">${r.status}</span></td><td class="px-4 py-4 align-top text-slate-600 whitespace-pre-wrap">${r.note}</td><td class="px-4 py-4 align-top">${r.evidence_files&&r.evidence_files.length>0?r.evidence_files.map(u=>`<a href="${u}" target="_blank" class="text-blue-600 hover:underline block mb-1 truncate max-w-xs">üìé ${u.split('/').pop()}</a>`).join('<br>'):'<span class="text-slate-400 italic">-</span>'}</td></tr>`).join('')}</tbody></table></div></div></div><div class="fixed bottom-8 right-8 no-print"><button onclick="window.print()" class="bg-blue-600 text-white p-4 rounded-full shadow-xl hover:bg-blue-700 transition flex items-center font-bold"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 17h2a2 2 0 002-2v-4a2 2 0 00-2-2H5a2 2 0 00-2 2v4a2 2 0 002 2h2m2 4h6a2 2 0 002-2v-4a2 2 0 00-2-2H9a2 2 0 00-2 2v4a2 2 0 002 2zm8-12V5a2 2 0 00-2-2H9a2 2 0 00-2 2v4h10z"/></svg>IN B√ÅO C√ÅO (PDF)</button></div><script>document.addEventListener('DOMContentLoaded',()=>{new Chart(document.getElementById('domainChart').getContext('2d'),{type:'radar',data:{labels:${JSON.stringify(chartLabels)},datasets:[{label:'M·ª©c ƒë·ªô tr∆∞·ªüng th√†nh (%)',data:${JSON.stringify(chartData)},backgroundColor:'rgba(37, 99, 235, 0.2)',borderColor:'rgb(37, 99, 235)',pointBackgroundColor:'rgb(37, 99, 235)',pointBorderColor:'#fff',pointHoverBackgroundColor:'#fff',pointHoverBorderColor:'rgb(37, 99, 235)'}]},options:{responsive:true,maintainAspectRatio:false,scales:{r:{angleLines:{display:true},suggestedMin:0,suggestedMax:100}},plugins:{legend:{position:'top'}}}})});<\/script></body></html>`;
        saveAs(new Blob([reportHTML], { type: "text/html;charset=utf-8" }), `Bao_cao_NIST_CSF_${safeName}_${now.toISOString().slice(0,10)}.html`);
        els.reportFileName.textContent = `Bao_cao_NIST_CSF_${safeName}_${now.toISOString().slice(0,10)}.html`; showScreen('done'); isDirty = false;
    } catch (e) { console.error(e); alert("L·ªói khi t·∫°o b√°o c√°o: " + e.message); }
}

document.addEventListener('DOMContentLoaded', () => {
    els.startButton.addEventListener('click', startAudit);
    els.controlStatus.addEventListener('change', () => { saveCurrentAnswer(); updateProgress(); });
    els.prevButton.addEventListener('click', prevQuestion);
    els.nextButton.addEventListener('click', nextQuestion);
    els.saveReportButton.addEventListener('click', generateReport);
    els.controlEvidenceUpload.addEventListener('change', handleFileUpload);
    els.restartButton.addEventListener('click', () => { els.clientNameInput.value = ""; showScreen('setup'); });
});
</script>
</body>
</html>